<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Label Maker for Addresses</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .template-selector {
            margin-bottom: 30px;
        }

        .template-selector label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .template-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            background: white;
        }

        .template-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-button:hover {
            background: #f0f2ff;
        }

        .tab-button.active:hover {
            background: #5568d3;
        }

        .input-section {
            display: none;
        }

        .input-section.active {
            display: block;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .drop-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .drop-zone.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .drop-zone-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .drop-zone-hint {
            color: #999;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .manual-entry {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
        }

        .manual-entry h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .address-form {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        .address-form input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .address-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.processing {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .instructions {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .format-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .format-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .format-example {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: "Courier New", monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            color: #666;
            font-size: 12px;
            line-height: 1.6;
        }

        .footer-disclaimer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .footer-disclaimer strong {
            color: #721c24;
        }

        .footer-links {
            margin-top: 15px;
        }

        .footer-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .footer-copyright {
            margin-top: 15px;
            font-size: 11px;
            color: #999;
        }

        .download-example {
            display: inline-block;
            margin-top: 10px;
            color: #667eea;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
        }

        .download-example:hover {
            text-decoration: underline;
            color: #5568d3;
        }

        /* Preview Section Styles */
        .preview-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 2px solid #667eea;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-header h3 {
            color: #333;
            font-size: 18px;
        }

        .preview-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .preview-stats span {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
        }

        .preview-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .preview-item {
            position: relative;
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .preview-item-number {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        .preview-item-name {
            font-weight: 500;
            color: #333;
        }

        .preview-item-details {
            font-size: 13px;
            color: #666;
        }

        .preview-buttons {
            display: flex;
            gap: 10px;
        }

        .preview-buttons .btn {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }

        .btn-generate {
            background: #28a745;
            color: white;
        }

        .btn-generate:hover {
            background: #218838;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        /* Full Sheet Checkbox Styles */
        .full-sheet-option {
            margin-top: 15px;
            padding: 12px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b8daff;
        }

        .full-sheet-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .full-sheet-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .full-sheet-hint {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            margin-left: 28px;
        }

        /* Export CSV section */
        .export-csv-section {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 1px solid #b8dce8;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .export-csv-info {
            flex: 1;
        }

        .export-csv-info strong {
            color: #0c5460;
            font-size: 14px;
        }

        .export-csv-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #666;
        }

        .export-btn {
            padding: 12px 20px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .export-btn:hover {
            background: #138496;
        }

        /* Preview item edit styles */
        .preview-item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 5px;
        }

        .btn-edit, .btn-delete {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .preview-item.editing {
            background: #fff9e6;
            border-left-color: #ffc107;
        }

        .preview-item .edit-form {
            display: none;
        }

        .preview-item.editing .edit-form {
            display: block;
        }

        .preview-item.editing .preview-item-content {
            display: none;
        }

        .preview-item.editing .preview-item-actions {
            display: none;
        }

        .edit-form input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .edit-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .edit-form-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-save {
            background: #28a745;
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-cancel-edit {
            background: #6c757d;
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-cancel-edit:hover {
            background: #5a6268;
        }

        /* Multi-column form layout */
        .form-row {
            display: grid;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .form-row.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row.four-col {
            grid-template-columns: 1fr 100px 120px 100px;
        }

        .form-row.name-row {
            grid-template-columns: 70px 1fr 1fr 60px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Address 2 placement toggle */
        .address2-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding: 10px;
            background: #f0f2ff;
            border-radius: 6px;
            font-size: 13px;
        }

        .address2-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #555;
        }

        .address2-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .address2-hint {
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }

        /* Return address section styling */
        .return-address-entry {
            background: #f0fff4;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #c3e6cb;
        }

        .return-address-entry h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .return-address-info {
            background: #d4edda;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #155724;
        }

        @media (max-width: 600px) {
            .form-row.two-col,
            .form-row.three-col,
            .form-row.four-col,
            .form-row.name-row {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Free Label Maker for Addresses</h1>
        <p class="subtitle">Generate professional PDF address labels - Works with Avery & compatible brands</p>

        <!-- Template Selector -->
        <div class="template-selector">
            <label for="templateSelect">Select Label Template:</label>
            <select id="templateSelect">
                <option value="8160">Avery 8160/5160 - Standard Address (1" √ó 2‚Öù", 30 per sheet) ‚≠ê Most Popular</option>
                <option value="5162">Avery 5162/8162 - Wide Address (1‚Öì" √ó 4", 14 per sheet)</option>
                <option value="5167">Avery 5167/8167 - Return Address (¬Ω" √ó 1¬æ", 80 per sheet)</option>
                <option value="5161">Avery 5161/8161 - Large Address (1" √ó 4", 20 per sheet)</option>
                <option value="5163">Avery 5163/8163 - Shipping Labels (2" √ó 4", 10 per sheet)</option>
                <option value="5164">Avery 5164/8164 - Large Shipping (3‚Öì" √ó 4", 6 per sheet)</option>
            </select>
        </div>

        <!-- Input Method Tabs -->
        <div class="input-tabs">
            <button class="tab-button active" onclick="switchTab('upload')">Upload File</button>
            <button class="tab-button" onclick="switchTab('manual')">Manual Entry</button>
            <button class="tab-button" onclick="switchTab('return')">Return Address</button>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="input-section active">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">üìÑ</div>
                <div class="drop-zone-text">Drag & drop your CSV/TSV file here</div>
                <div class="drop-zone-hint">or click to browse</div>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.tsv,.txt">

            <div class="format-info">
                <h3>Expected File Format</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="#" class="download-example" onclick="downloadExampleCSV(); return false;">üì• Download example.csv</a>
                    <a href="#" class="download-example" onclick="downloadExampleExcel(); return false;">üìä Download example.xlsx</a>
                </div>
                <p style="margin-top: 15px;">Your CSV file can use either format:</p>
                <div class="format-example" style="font-size: 11px;">
                    <strong>Expanded format (recommended):</strong><br>
                    Title,First Name,Last Name,Suffix,Address 1,Address 2,City,State,Postal Code,Country<br>
                    Dr.,Jane,Doe,PhD,456 Oak Ave,Suite 200,Boston,MA,02101,USA<br><br>
                    <strong>Simple format (also works):</strong><br>
                    Fullname,Address,City State Zip<br>
                    John Smith,123 Main St,New York NY 10001
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #888;">
                    üí° <strong>Tip:</strong> Download the Excel file, edit it with your addresses, then save as CSV to upload here.
                </p>
            </div>

            <!-- Preview Section for File Upload -->
            <div id="previewSection" class="preview-section">
                <div class="preview-header">
                    <h3>Preview Addresses</h3>
                    <div class="preview-stats">
                        <span id="previewCount">0 addresses</span>
                        <span id="previewPages">0 pages</span>
                    </div>
                </div>
                <div id="previewList" class="preview-list"></div>
                <div id="uploadFullSheetOption" class="full-sheet-option" style="display: none;">
                    <label>
                        <input type="checkbox" id="uploadFullSheetCheckbox" onchange="updateUploadPreviewStats()">
                        Fill entire sheet with the same address
                    </label>
                    <div id="uploadFullSheetHint" class="full-sheet-hint">
                        Creates 30 labels of the same address (based on current template)
                    </div>
                </div>
                <div class="preview-buttons">
                    <button class="btn btn-cancel" onclick="cancelPreview()">Cancel</button>
                    <button class="btn btn-generate" onclick="generateFromPreview()">Generate PDF</button>
                </div>
            </div>
        </div>

        <!-- Manual Entry Section -->
        <div id="manualSection" class="input-section">
            <div class="manual-entry">
                <h3>Add Address</h3>
                <div class="address-form">
                    <!-- Name Row: Title, First, Last, Suffix -->
                    <div class="form-row name-row">
                        <div class="form-group">
                            <label for="manualTitle">Title</label>
                            <input type="text" id="manualTitle" placeholder="Hon.">
                        </div>
                        <div class="form-group">
                            <label for="manualFirst">First Name *</label>
                            <input type="text" id="manualFirst" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label for="manualLast">Last Name *</label>
                            <input type="text" id="manualLast" placeholder="Smith">
                        </div>
                        <div class="form-group">
                            <label for="manualSuffix">Suffix</label>
                            <input type="text" id="manualSuffix" placeholder="Jr.">
                        </div>
                    </div>
                    <!-- Address Row -->
                    <div class="form-group">
                        <label for="manualAddress1">Address Line 1 *</label>
                        <input type="text" id="manualAddress1" placeholder="123 Main St">
                    </div>
                    <div class="form-group">
                        <label for="manualAddress2">Address Line 2</label>
                        <input type="text" id="manualAddress2" placeholder="Apt 4B, Suite 100, etc.">
                    </div>
                    <div class="address2-option" id="address2Option" style="display: none;">
                        <label>
                            <input type="checkbox" id="manualAddress2SameLine">
                            Print Address 2 on same line as Address 1
                        </label>
                        <span class="address2-hint">Per USPS, some addresses require this</span>
                    </div>
                    <!-- City, State, Postal Code, Country Row -->
                    <div class="form-row four-col">
                        <div class="form-group">
                            <label for="manualCity">City *</label>
                            <input type="text" id="manualCity" placeholder="New York">
                        </div>
                        <div class="form-group">
                            <label for="manualState">State *</label>
                            <input type="text" id="manualState" placeholder="NY">
                        </div>
                        <div class="form-group">
                            <label for="manualPostalCode">Postal Code *</label>
                            <input type="text" id="manualPostalCode" placeholder="10001">
                        </div>
                        <div class="form-group">
                            <label for="manualCountry">Country</label>
                            <input type="text" id="manualCountry" placeholder="USA">
                        </div>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="btn btn-primary" onclick="addManualAddress()">Add Address</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
                </div>

                <!-- Addresses List Section (like file upload preview) -->
                <div id="manualAddressesSection" class="preview-section">
                    <div class="preview-header">
                        <h3>Your Addresses</h3>
                        <div class="preview-stats">
                            <span id="manualAddressCount">0 addresses</span>
                            <span id="manualPageCount">0 pages</span>
                        </div>
                    </div>
                    <div id="manualAddressesList" class="preview-list"></div>

                    <div id="manualFullSheetOption" class="full-sheet-option" style="display: none;">
                        <label>
                            <input type="checkbox" id="manualFullSheetCheckbox" onchange="updateManualStats()">
                            Fill entire sheet with the same address
                        </label>
                        <div id="manualFullSheetHint" class="full-sheet-hint">
                            Creates 30 labels of the same address (based on current template)
                        </div>
                    </div>

                    <div class="preview-buttons">
                        <button class="btn btn-cancel" onclick="clearAllAddresses()">Clear All</button>
                        <button class="btn btn-generate" onclick="generateFromManual()">Generate PDF</button>
                    </div>

                    <div class="export-csv-section" style="margin-top: 15px;">
                        <div class="export-csv-info">
                            <strong>Save for Next Time</strong>
                            <p>Export your addresses to a CSV file so you can quickly import them next year instead of typing them again.</p>
                        </div>
                        <button class="export-btn" onclick="exportManualAddressesCSV()">
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Return Address Section -->
        <div id="returnSection" class="input-section">
            <div class="return-address-entry">
                <h3>Create Return Address Labels</h3>
                <div class="return-address-info">
                    Fill in your address once and generate a full sheet of identical labels - perfect for return address labels!
                </div>
                <div class="address-form">
                    <!-- Name Row: Title, First, Last, Suffix -->
                    <div class="form-row name-row">
                        <div class="form-group">
                            <label for="returnTitle">Title</label>
                            <input type="text" id="returnTitle" placeholder="Hon.">
                        </div>
                        <div class="form-group">
                            <label for="returnFirst">First Name *</label>
                            <input type="text" id="returnFirst" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label for="returnLast">Last Name *</label>
                            <input type="text" id="returnLast" placeholder="Smith">
                        </div>
                        <div class="form-group">
                            <label for="returnSuffix">Suffix</label>
                            <input type="text" id="returnSuffix" placeholder="Jr.">
                        </div>
                    </div>
                    <!-- Address Row -->
                    <div class="form-group">
                        <label for="returnAddress1">Address Line 1 *</label>
                        <input type="text" id="returnAddress1" placeholder="123 Main St">
                    </div>
                    <div class="form-group">
                        <label for="returnAddress2">Address Line 2</label>
                        <input type="text" id="returnAddress2" placeholder="Apt 4B, Suite 100, etc.">
                    </div>
                    <div class="address2-option" id="returnAddress2Option" style="display: none;">
                        <label>
                            <input type="checkbox" id="returnAddress2SameLine">
                            Print Address 2 on same line as Address 1
                        </label>
                        <span class="address2-hint">Per USPS, some addresses require this</span>
                    </div>
                    <!-- City, State, Postal Code, Country Row -->
                    <div class="form-row four-col">
                        <div class="form-group">
                            <label for="returnCity">City *</label>
                            <input type="text" id="returnCity" placeholder="New York">
                        </div>
                        <div class="form-group">
                            <label for="returnState">State *</label>
                            <input type="text" id="returnState" placeholder="NY">
                        </div>
                        <div class="form-group">
                            <label for="returnPostalCode">Postal Code *</label>
                            <input type="text" id="returnPostalCode" placeholder="10001">
                        </div>
                        <div class="form-group">
                            <label for="returnCountry">Country</label>
                            <input type="text" id="returnCountry" placeholder="USA">
                        </div>
                    </div>
                </div>
                <div class="form-buttons" style="margin-top: 15px;">
                    <button class="btn btn-generate" onclick="generateReturnLabels()" style="flex: 2;">Generate Full Sheet</button>
                    <button class="btn btn-secondary" onclick="clearReturnForm()">Clear</button>
                </div>
                <div id="returnLabelInfo" style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px; font-size: 13px; color: #666;">
                    Selected template: <strong id="returnTemplateInfo">Avery 8160 - 30 labels per sheet</strong>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>

        <!-- Printing Instructions -->
        <div class="instructions">
            <h3>üìã Important Printing Instructions</h3>
            <ul>
                <li><strong>Print Scale:</strong> Set to <strong>100%</strong> or "Actual Size" (NOT "Fit to Page")</li>
                <li><strong>Paper Size:</strong> US Letter (8.5" √ó 11")</li>
                <li><strong>Test First:</strong> Print one page on regular paper and hold it up to the light against your label sheet to check alignment</li>
                <li><strong>No Margins Override:</strong> Use the PDF's built-in margins</li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-disclaimer">
                <strong>‚ö†Ô∏è DISCLAIMER - USE AT YOUR OWN RISK</strong><br>
                This software is provided "AS IS" without warranty of any kind, express or implied.
                The creators and contributors are not liable for any damages, printing errors, wasted materials,
                or other issues that may arise from using this tool. Always test print on regular paper first
                before using actual label sheets.
            </div>

            <div>
                <strong>Legal Notice:</strong> This is an independent, open-source tool. We are not affiliated with,
                endorsed by, or sponsored by Avery Dennison Corporation or any other label manufacturer.
                "Avery" and related trademarks are the property of their respective owners.
            </div>

            <div class="footer-links">
                <a href="https://github.com/blondfrogs/label-maker" target="_blank">GitHub</a>
                <a href="https://github.com/blondfrogs/label-maker/blob/master/LICENSE" target="_blank">MIT License</a>
                <a href="https://github.com/blondfrogs/label-maker/issues" target="_blank">Report Issue</a>
            </div>

            <div class="footer-copyright">
                ¬© 2025 Free Label Maker | Open Source Project |
                Your privacy is protected - all processing happens in your browser, no data is sent to any server.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Label templates configuration - All measurements in inches
        // Format: { width, height, topMargin, sideMargin, hPitch (horizontal spacing), vPitch (vertical spacing), cols, rows }
        const TEMPLATES = {
            '8160': { width: 2.625, height: 1.0, topMargin: 0.5, sideMargin: 0.19, hPitch: 2.75, vPitch: 1.0, cols: 3, rows: 10 },
            '5160': { width: 2.625, height: 1.0, topMargin: 0.5, sideMargin: 0.19, hPitch: 2.75, vPitch: 1.0, cols: 3, rows: 10 },
            '5162': { width: 4.0, height: 1.33, topMargin: 0.5, sideMargin: 0.16, hPitch: 4.19, vPitch: 1.33, cols: 2, rows: 7 },
            '5167': { width: 1.75, height: 0.5, topMargin: 0.5, sideMargin: 0.28, hPitch: 2.06, vPitch: 0.5, cols: 4, rows: 20 },
            '5161': { width: 4.0, height: 1.0, topMargin: 0.5, sideMargin: 0.16, hPitch: 4.19, vPitch: 1.0, cols: 2, rows: 10 },
            '5163': { width: 4.0, height: 2.0, topMargin: 0.5, sideMargin: 0.16, hPitch: 4.19, vPitch: 2.0, cols: 2, rows: 5 },
            '5164': { width: 4.0, height: 3.33, topMargin: 0.5, sideMargin: 0.16, hPitch: 4.19, vPitch: 3.33, cols: 2, rows: 3 }
        };

        let currentTemplate = '8160';
        let manualAddresses = [];
        let previewAddresses = [];

        const STORAGE_KEY = 'labelMakerAddresses';
        const UPLOAD_STORAGE_KEY = 'labelMakerUploadedAddresses';
        const RETURN_STORAGE_KEY = 'labelMakerReturnAddress';

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const templateSelect = document.getElementById('templateSelect');

        templateSelect.addEventListener('change', (e) => {
            currentTemplate = e.target.value;
            updateManualFullSheetHint();
            updateManualStats();
            updateUploadFullSheetHint();
            updateUploadPreviewStats();
            updateReturnTemplateInfo();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAddressesFromStorage();
            loadUploadedAddressesFromStorage();
            loadReturnAddressFromStorage();
            setupAddress2Listeners();
            updateReturnTemplateInfo();
        });

        // Setup address2 field listeners to show/hide same-line option
        function setupAddress2Listeners() {
            const manualAddr2 = document.getElementById('manualAddress2');
            const returnAddr2 = document.getElementById('returnAddress2');

            if (manualAddr2) {
                manualAddr2.addEventListener('input', () => {
                    const option = document.getElementById('address2Option');
                    option.style.display = manualAddr2.value.trim() ? '' : 'none';
                });
            }

            if (returnAddr2) {
                returnAddr2.addEventListener('input', () => {
                    const option = document.getElementById('returnAddress2Option');
                    option.style.display = returnAddr2.value.trim() ? '' : 'none';
                });
            }
        }

        // Update return template info display
        function updateReturnTemplateInfo() {
            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const info = document.getElementById('returnTemplateInfo');
            if (info) {
                const templateNames = {
                    '8160': 'Avery 8160',
                    '5160': 'Avery 5160',
                    '5162': 'Avery 5162',
                    '5167': 'Avery 5167 (Return Address)',
                    '5161': 'Avery 5161',
                    '5163': 'Avery 5163',
                    '5164': 'Avery 5164'
                };
                info.textContent = `${templateNames[currentTemplate] || currentTemplate} - ${labelsPerPage} labels per sheet`;
            }
        }

        // Save addresses to localStorage
        function saveAddressesToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(manualAddresses));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        // Load addresses from localStorage
        function loadAddressesFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    manualAddresses = JSON.parse(saved);
                    updateAddressesList();
                    if (manualAddresses.length > 0) {
                        showStatus(`Restored ${manualAddresses.length} saved address${manualAddresses.length !== 1 ? 'es' : ''} from your last session.`, 'success');
                    }
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Save uploaded addresses to localStorage
        function saveUploadedAddressesToStorage() {
            try {
                localStorage.setItem(UPLOAD_STORAGE_KEY, JSON.stringify(previewAddresses));
            } catch (e) {
                console.warn('Could not save uploaded addresses to localStorage:', e);
            }
        }

        // Load uploaded addresses from localStorage
        function loadUploadedAddressesFromStorage() {
            try {
                const saved = localStorage.getItem(UPLOAD_STORAGE_KEY);
                if (saved) {
                    previewAddresses = JSON.parse(saved);
                    if (previewAddresses.length > 0) {
                        showPreview(previewAddresses);
                        showStatus(`Restored ${previewAddresses.length} uploaded address${previewAddresses.length !== 1 ? 'es' : ''} from your last session.`, 'success');
                    }
                }
            } catch (e) {
                console.warn('Could not load uploaded addresses from localStorage:', e);
            }
        }

        // Clear uploaded addresses from storage
        function clearUploadedAddressesFromStorage() {
            try {
                localStorage.removeItem(UPLOAD_STORAGE_KEY);
            } catch (e) {
                console.warn('Could not clear uploaded addresses from localStorage:', e);
            }
        }

        // Save return address to localStorage
        function saveReturnAddressToStorage() {
            const returnAddress = getReturnAddressFromForm();
            if (returnAddress) {
                try {
                    localStorage.setItem(RETURN_STORAGE_KEY, JSON.stringify(returnAddress));
                } catch (e) {
                    console.warn('Could not save return address to localStorage:', e);
                }
            }
        }

        // Load return address from localStorage
        function loadReturnAddressFromStorage() {
            try {
                const saved = localStorage.getItem(RETURN_STORAGE_KEY);
                if (saved) {
                    const addr = JSON.parse(saved);
                    document.getElementById('returnTitle').value = addr.title || '';
                    document.getElementById('returnFirst').value = addr.firstName || '';
                    document.getElementById('returnLast').value = addr.lastName || '';
                    document.getElementById('returnSuffix').value = addr.suffix || '';
                    document.getElementById('returnAddress1').value = addr.address1 || '';
                    document.getElementById('returnAddress2').value = addr.address2 || '';
                    document.getElementById('returnAddress2SameLine').checked = addr.address2SameLine || false;
                    document.getElementById('returnAddress2Option').style.display = addr.address2 ? '' : 'none';
                    document.getElementById('returnCity').value = addr.city || '';
                    document.getElementById('returnState').value = addr.state || '';
                    document.getElementById('returnPostalCode').value = addr.postalCode || '';
                    document.getElementById('returnCountry').value = addr.country || '';
                }
            } catch (e) {
                console.warn('Could not load return address from localStorage:', e);
            }
        }

        // Get return address from form
        function getReturnAddressFromForm() {
            const firstName = document.getElementById('returnFirst').value.trim();
            const lastName = document.getElementById('returnLast').value.trim();
            const address1 = document.getElementById('returnAddress1').value.trim();
            const city = document.getElementById('returnCity').value.trim();
            const state = document.getElementById('returnState').value.trim();
            const postalCode = document.getElementById('returnPostalCode').value.trim();

            if (!firstName || !lastName || !address1 || !city || !state || !postalCode) {
                return null;
            }

            return {
                title: document.getElementById('returnTitle').value.trim(),
                firstName,
                lastName,
                suffix: document.getElementById('returnSuffix').value.trim(),
                address1,
                address2: document.getElementById('returnAddress2').value.trim(),
                address2SameLine: document.getElementById('returnAddress2SameLine').checked,
                city,
                state,
                postalCode,
                country: document.getElementById('returnCountry').value.trim()
            };
        }

        // Generate return address labels (full sheet)
        function generateReturnLabels() {
            const returnAddress = getReturnAddressFromForm();
            if (!returnAddress) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            // Save for next time
            saveReturnAddressToStorage();

            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;

            // Fill entire sheet with the same address
            const addressesToPrint = Array(labelsPerPage).fill(returnAddress);

            showStatus(`Generating ${labelsPerPage} return address labels...`, 'processing');

            try {
                const pdf = generateLabelsPDF(addressesToPrint);
                pdf.save(`${currentTemplate}-return-labels.pdf`);

                showStatus(`‚úì Success! Generated ${labelsPerPage} return address labels (1 page). PDF download started.`, 'success');
            } catch (error) {
                console.error(error);
                showStatus('Error generating labels: ' + error.message, 'error');
            }
        }

        // Clear return address form
        function clearReturnForm() {
            document.getElementById('returnTitle').value = '';
            document.getElementById('returnFirst').value = '';
            document.getElementById('returnLast').value = '';
            document.getElementById('returnSuffix').value = '';
            document.getElementById('returnAddress1').value = '';
            document.getElementById('returnAddress2').value = '';
            document.getElementById('returnAddress2SameLine').checked = false;
            document.getElementById('returnAddress2Option').style.display = 'none';
            document.getElementById('returnCity').value = '';
            document.getElementById('returnState').value = '';
            document.getElementById('returnPostalCode').value = '';
            document.getElementById('returnCountry').value = '';
            try {
                localStorage.removeItem(RETURN_STORAGE_KEY);
            } catch (e) {}
        }

        // Clear all saved addresses
        function clearAllAddresses() {
            if (manualAddresses.length === 0) return;
            if (confirm(`Are you sure you want to delete all ${manualAddresses.length} address${manualAddresses.length !== 1 ? 'es' : ''}? This cannot be undone.`)) {
                manualAddresses = [];
                saveAddressesToStorage();
                updateAddressesList();
                showStatus('All addresses have been cleared.', 'success');
            }
        }

        function switchTab(tab) {
            const buttons = document.querySelectorAll('.tab-button');
            const sections = document.querySelectorAll('.input-section');

            buttons.forEach(btn => btn.classList.remove('active'));
            sections.forEach(section => section.classList.remove('active'));

            if (tab === 'upload') {
                buttons[0].classList.add('active');
                document.getElementById('uploadSection').classList.add('active');
            } else if (tab === 'manual') {
                buttons[1].classList.add('active');
                document.getElementById('manualSection').classList.add('active');
            } else if (tab === 'return') {
                buttons[2].classList.add('active');
                document.getElementById('returnSection').classList.add('active');
            }
        }

        // File upload handlers
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseData(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];

            // Parse header to detect format
            let headerParts;
            if (lines[0].includes('\t')) {
                headerParts = lines[0].split('\t').map(p => p.trim().toLowerCase());
            } else {
                headerParts = parseCSVLine(lines[0]).map(p => p.toLowerCase());
            }

            // Detect if new format (has "first name" or similar columns)
            const isNewFormat = headerParts.some(h =>
                h.includes('first') || h.includes('last') || h.includes('postal') || h.includes('address 1')
            );

            const dataLines = lines.slice(1);

            return dataLines.map(line => {
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t').map(p => p.trim());
                } else {
                    parts = parseCSVLine(line);
                }

                if (isNewFormat && parts.length >= 7) {
                    // New expanded format: Title, First, Last, Suffix, Address1, Address2, City, State, PostalCode, Country
                    return {
                        title: parts[0] || '',
                        firstName: parts[1] || '',
                        lastName: parts[2] || '',
                        suffix: parts[3] || '',
                        address1: parts[4] || '',
                        address2: parts[5] || '',
                        address2SameLine: false,
                        city: parts[6] || '',
                        state: parts[7] || '',
                        postalCode: parts[8] || '',
                        country: parts[9] || ''
                    };
                } else if (parts.length >= 3) {
                    // Old 3-column format: Fullname, Address, CityStateZip
                    const fullname = parts[0];
                    const address = parts[1];
                    let cityStateZip;

                    if (parts.length === 3) {
                        cityStateZip = parts[2];
                    } else if (parts.length === 4) {
                        cityStateZip = parts[2] + ' ' + parts[3];
                    } else {
                        cityStateZip = parts.slice(2).join(', ');
                    }

                    return { fullname, address, cityStateZip };
                }
                return null;
            }).filter(item => item !== null);
        }

        // Format address data for label - handles both old and new formats
        function formatAddressForLabel(addressData) {
            // Check if this is the new format (has firstName field) or old format
            if (addressData.firstName !== undefined) {
                // New format - build name line from components
                const nameParts = [];
                if (addressData.title) nameParts.push(addressData.title);
                if (addressData.firstName) nameParts.push(addressData.firstName);
                if (addressData.lastName) nameParts.push(addressData.lastName);
                if (addressData.suffix) nameParts.push(addressData.suffix);
                const fullname = nameParts.join(' ');

                // Build address lines
                let addressLine1 = addressData.address1 || '';
                let addressLine2 = addressData.address2 || '';
                const address2SameLine = addressData.address2SameLine || false;

                // Build location line
                const locationParts = [];
                if (addressData.city) locationParts.push(addressData.city);
                if (addressData.state) {
                    if (locationParts.length > 0) {
                        locationParts[locationParts.length - 1] += ',';
                    }
                    locationParts.push(addressData.state);
                }
                if (addressData.postalCode) locationParts.push(addressData.postalCode);
                if (addressData.country && addressData.country.toUpperCase() !== 'USA' && addressData.country.toUpperCase() !== 'US') {
                    locationParts.push(addressData.country);
                }
                const location = locationParts.join(' ');

                return { fullname, addressLine1, addressLine2, address2SameLine, location };
            } else {
                // Old format - use as-is for backward compatibility
                return {
                    fullname: addressData.fullname || '',
                    addressLine1: addressData.address || '',
                    addressLine2: '',
                    address2SameLine: false,
                    location: addressData.cityStateZip || ''
                };
            }
        }

        function drawLabel(pdf, addressData, x, y, template) {
            if (!addressData) return;

            const formatted = formatAddressForLabel(addressData);

            // Adjust font sizes and spacing based on label size
            let nameFontSize, addressFontSize, lineSpacing, startPadding;

            if (template.height <= 0.5) {
                // Small labels like 5167 (return address)
                nameFontSize = 7;
                addressFontSize = 6;
                lineSpacing = 0.08;
                startPadding = 0.08;
            } else if (template.height <= 1.0) {
                // Standard address labels
                nameFontSize = 11;
                addressFontSize = 10;
                lineSpacing = 0.15;
                startPadding = 0.25;
            } else {
                // Large shipping labels
                nameFontSize = 13;
                addressFontSize = 11;
                lineSpacing = 0.18;
                startPadding = 0.3;
            }

            const padding = 0.08;
            const startX = x + padding;
            let currentY = y + padding + startPadding;

            // Name line
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(nameFontSize);
            pdf.text(formatted.fullname, startX, currentY);
            currentY += lineSpacing;

            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(addressFontSize);

            // Address line(s)
            if (formatted.address2SameLine && formatted.addressLine2) {
                // Address 2 on same line as Address 1
                pdf.text(formatted.addressLine1 + ' ' + formatted.addressLine2, startX, currentY);
                currentY += lineSpacing;
            } else {
                // Address 1
                pdf.text(formatted.addressLine1, startX, currentY);
                currentY += lineSpacing;

                // Address 2 on separate line (if exists)
                if (formatted.addressLine2) {
                    pdf.text(formatted.addressLine2, startX, currentY);
                    currentY += lineSpacing;
                }
            }

            // Location line (City, State, Postal Code, Country)
            pdf.text(formatted.location, startX, currentY);
        }

        function generateLabelsPDF(addresses) {
            const template = TEMPLATES[currentTemplate];
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'in',
                format: 'letter'
            });

            const labelsPerPage = template.cols * template.rows;
            const totalPages = Math.ceil(addresses.length / labelsPerPage);

            for (let page = 0; page < totalPages; page++) {
                if (page > 0) pdf.addPage();

                const pageStartIndex = page * labelsPerPage;

                for (let row = 0; row < template.rows; row++) {
                    for (let col = 0; col < template.cols; col++) {
                        const labelIndex = pageStartIndex + (row * template.cols) + col;
                        if (labelIndex >= addresses.length) break;

                        const addressData = addresses[labelIndex];
                        const x = template.sideMargin + (col * template.hPitch);
                        const y = template.topMargin + (row * template.vPitch);

                        drawLabel(pdf, addressData, x, y, template);
                    }
                }
            }

            return pdf;
        }

        async function handleFile(file) {
            showStatus('Processing file...', 'processing');

            try {
                const content = await file.text();
                const addresses = parseData(content);

                if (addresses.length === 0) {
                    showStatus('No valid addresses found in file. Please check the format.', 'error');
                    return;
                }

                // Store addresses for preview and save to storage
                previewAddresses = addresses;
                saveUploadedAddressesToStorage();
                showPreview(addresses);
                showStatus(`Found ${addresses.length} addresses. Review below and click "Generate PDF" to create labels.`, 'success');

            } catch (error) {
                console.error(error);
                showStatus('Error processing file: ' + error.message, 'error');
            }
        }

        function showPreview(addresses) {
            const previewSection = document.getElementById('previewSection');
            const previewList = document.getElementById('previewList');
            const fullSheetOption = document.getElementById('uploadFullSheetOption');
            const fullSheetCheckbox = document.getElementById('uploadFullSheetCheckbox');

            // Show/hide full sheet option based on address count
            if (addresses.length === 1) {
                fullSheetOption.style.display = '';
                updateUploadFullSheetHint();
            } else {
                fullSheetOption.style.display = 'none';
                fullSheetCheckbox.checked = false;
            }

            // Update stats
            updateUploadPreviewStats();

            // Build preview list with edit/delete buttons
            renderUploadPreviewList();

            // Show preview section
            previewSection.classList.add('active');
        }

        function renderUploadPreviewList() {
            const previewList = document.getElementById('previewList');
            previewList.innerHTML = previewAddresses.map((addr, index) => {
                const display = getAddressDisplayText(addr);
                return `
                <div class="preview-item" id="upload-preview-${index}">
                    <div class="preview-item-content">
                        <div class="preview-item-number">Address #${index + 1}</div>
                        <div class="preview-item-name">${escapeHtml(display.name)}</div>
                        <div class="preview-item-details">${display.address}<br>${escapeHtml(display.location)}</div>
                    </div>
                    <div class="preview-item-actions">
                        <button class="btn-delete" onclick="deleteUploadAddress(${index})">Delete</button>
                    </div>
                </div>
            `}).join('');

            // Update full sheet visibility
            const fullSheetOption = document.getElementById('uploadFullSheetOption');
            if (previewAddresses.length === 1) {
                fullSheetOption.style.display = '';
            } else {
                fullSheetOption.style.display = 'none';
                document.getElementById('uploadFullSheetCheckbox').checked = false;
            }

            updateUploadPreviewStats();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function deleteUploadAddress(index) {
            if (previewAddresses.length === 1) {
                if (confirm('This will remove the last address and cancel the preview. Continue?')) {
                    cancelPreview();
                }
                return;
            }
            previewAddresses.splice(index, 1);
            saveUploadedAddressesToStorage();
            renderUploadPreviewList();
        }

        function updateUploadFullSheetHint() {
            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const hint = document.getElementById('uploadFullSheetHint');
            if (hint) {
                hint.textContent = `Creates ${labelsPerPage} labels of the same address (based on current template)`;
            }
        }

        function updateUploadPreviewStats() {
            if (previewAddresses.length === 0) return;

            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const fullSheetCheckbox = document.getElementById('uploadFullSheetCheckbox');

            let labelCount = previewAddresses.length;
            if (fullSheetCheckbox && fullSheetCheckbox.checked && previewAddresses.length === 1) {
                labelCount = labelsPerPage;
            }

            const totalPages = Math.ceil(labelCount / labelsPerPage);

            document.getElementById('previewCount').textContent = `${labelCount} label${labelCount !== 1 ? 's' : ''}`;
            document.getElementById('previewPages').textContent = `${totalPages} page${totalPages !== 1 ? 's' : ''}`;
        }

        function cancelPreview() {
            previewAddresses = [];
            clearUploadedAddressesFromStorage();
            document.getElementById('previewSection').classList.remove('active');
            document.getElementById('previewList').innerHTML = '';
            document.getElementById('uploadFullSheetOption').style.display = 'none';
            document.getElementById('uploadFullSheetCheckbox').checked = false;
            fileInput.value = '';
            status.style.display = 'none';
        }

        function generateFromPreview() {
            if (previewAddresses.length === 0) return;

            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const fullSheetCheckbox = document.getElementById('uploadFullSheetCheckbox');

            let addressesToPrint = previewAddresses;

            // If full sheet is checked and there's exactly one address, replicate it
            if (fullSheetCheckbox.checked && previewAddresses.length === 1) {
                addressesToPrint = Array(labelsPerPage).fill(previewAddresses[0]);
            }

            showStatus(`Generating PDF labels for ${addressesToPrint.length} labels...`, 'processing');

            try {
                const pdf = generateLabelsPDF(addressesToPrint);
                pdf.save(`${currentTemplate}-labels.pdf`);

                // Also download CSV for future use (use original addresses, not duplicated)
                setTimeout(() => {
                    downloadAddressesCSV(previewAddresses, `${currentTemplate}-addresses.csv`);
                }, 500);

                const totalPages = Math.ceil(addressesToPrint.length / labelsPerPage);
                showStatus(`‚úì Success! Generated ${addressesToPrint.length} labels (${totalPages} page${totalPages > 1 ? 's' : ''}). PDF and CSV downloads started.`, 'success');

                // Clear preview after generating
                cancelPreview();
            } catch (error) {
                console.error(error);
                showStatus('Error generating labels: ' + error.message, 'error');
            }
        }

        // Manual entry functions
        function addManualAddress() {
            const title = document.getElementById('manualTitle').value.trim();
            const firstName = document.getElementById('manualFirst').value.trim();
            const lastName = document.getElementById('manualLast').value.trim();
            const suffix = document.getElementById('manualSuffix').value.trim();
            const address1 = document.getElementById('manualAddress1').value.trim();
            const address2 = document.getElementById('manualAddress2').value.trim();
            const address2SameLine = document.getElementById('manualAddress2SameLine').checked;
            const city = document.getElementById('manualCity').value.trim();
            const state = document.getElementById('manualState').value.trim();
            const postalCode = document.getElementById('manualPostalCode').value.trim();
            const country = document.getElementById('manualCountry').value.trim();

            // Validate required fields
            if (!firstName || !lastName || !address1 || !city || !state || !postalCode) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            manualAddresses.push({
                title, firstName, lastName, suffix,
                address1, address2, address2SameLine,
                city, state, postalCode, country
            });
            saveAddressesToStorage();
            updateAddressesList();
            clearForm();
        }

        function clearForm() {
            document.getElementById('manualTitle').value = '';
            document.getElementById('manualFirst').value = '';
            document.getElementById('manualLast').value = '';
            document.getElementById('manualSuffix').value = '';
            document.getElementById('manualAddress1').value = '';
            document.getElementById('manualAddress2').value = '';
            document.getElementById('manualAddress2SameLine').checked = false;
            document.getElementById('address2Option').style.display = 'none';
            document.getElementById('manualCity').value = '';
            document.getElementById('manualState').value = '';
            document.getElementById('manualPostalCode').value = '';
            document.getElementById('manualCountry').value = '';
        }

        // Helper to get display text for an address (handles both old and new formats)
        function getAddressDisplayText(addr) {
            const formatted = formatAddressForLabel(addr);
            let addressDisplay = formatted.addressLine1;
            if (formatted.addressLine2) {
                if (formatted.address2SameLine) {
                    addressDisplay += ' ' + formatted.addressLine2;
                } else {
                    addressDisplay += '<br>' + formatted.addressLine2;
                }
            }
            return {
                name: formatted.fullname,
                address: addressDisplay,
                location: formatted.location
            };
        }

        function updateAddressesList() {
            const section = document.getElementById('manualAddressesSection');
            const list = document.getElementById('manualAddressesList');
            const fullSheetOption = document.getElementById('manualFullSheetOption');

            if (manualAddresses.length === 0) {
                section.classList.remove('active');
                return;
            }

            // Show the section
            section.classList.add('active');

            // Update stats
            updateManualStats();

            // Only show full sheet option when exactly 1 address
            if (manualAddresses.length === 1) {
                fullSheetOption.style.display = '';
                updateManualFullSheetHint();
            } else {
                fullSheetOption.style.display = 'none';
                document.getElementById('manualFullSheetCheckbox').checked = false;
            }

            // Render addresses like file upload preview
            list.innerHTML = manualAddresses.map((addr, index) => {
                const display = getAddressDisplayText(addr);
                return `
                <div class="preview-item" id="manual-item-${index}">
                    <div class="preview-item-content">
                        <div class="preview-item-number">Address #${index + 1}</div>
                        <div class="preview-item-name">${escapeHtml(display.name)}</div>
                        <div class="preview-item-details">${display.address}<br>${escapeHtml(display.location)}</div>
                    </div>
                    <div class="preview-item-actions">
                        <button class="btn-edit" onclick="editManualAddress(${index})">Edit</button>
                        <button class="btn-delete" onclick="deleteManualAddress(${index})">Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        function updateManualStats() {
            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const fullSheetCheckbox = document.getElementById('manualFullSheetCheckbox');

            let labelCount = manualAddresses.length;
            if (fullSheetCheckbox && fullSheetCheckbox.checked && manualAddresses.length === 1) {
                labelCount = labelsPerPage;
            }

            const totalPages = Math.ceil(labelCount / labelsPerPage);

            document.getElementById('manualAddressCount').textContent = `${labelCount} label${labelCount !== 1 ? 's' : ''}`;
            document.getElementById('manualPageCount').textContent = `${totalPages} page${totalPages !== 1 ? 's' : ''}`;
        }

        function updateManualFullSheetHint() {
            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const hint = document.getElementById('manualFullSheetHint');
            if (hint) {
                hint.textContent = `Creates ${labelsPerPage} labels of the same address (based on current template)`;
            }
        }

        // Edit loads address into the form for modification
        function editManualAddress(index) {
            const addr = manualAddresses[index];

            // Handle both old and new format
            if (addr.firstName !== undefined) {
                // New format
                document.getElementById('manualTitle').value = addr.title || '';
                document.getElementById('manualFirst').value = addr.firstName || '';
                document.getElementById('manualLast').value = addr.lastName || '';
                document.getElementById('manualSuffix').value = addr.suffix || '';
                document.getElementById('manualAddress1').value = addr.address1 || '';
                document.getElementById('manualAddress2').value = addr.address2 || '';
                document.getElementById('manualAddress2SameLine').checked = addr.address2SameLine || false;
                document.getElementById('address2Option').style.display = addr.address2 ? '' : 'none';
                document.getElementById('manualCity').value = addr.city || '';
                document.getElementById('manualState').value = addr.state || '';
                document.getElementById('manualPostalCode').value = addr.postalCode || '';
                document.getElementById('manualCountry').value = addr.country || '';
            } else {
                // Old format - parse as best we can
                const nameParts = (addr.fullname || '').split(' ');
                document.getElementById('manualTitle').value = '';
                document.getElementById('manualFirst').value = nameParts[0] || '';
                document.getElementById('manualLast').value = nameParts.slice(1).join(' ') || '';
                document.getElementById('manualSuffix').value = '';
                document.getElementById('manualAddress1').value = addr.address || '';
                document.getElementById('manualAddress2').value = '';
                document.getElementById('manualAddress2SameLine').checked = false;
                document.getElementById('address2Option').style.display = 'none';
                // Parse cityStateZip - try to split
                const csz = addr.cityStateZip || '';
                document.getElementById('manualCity').value = csz;
                document.getElementById('manualState').value = '';
                document.getElementById('manualPostalCode').value = '';
                document.getElementById('manualCountry').value = '';
            }

            // Delete the old entry - user will re-add via form
            manualAddresses.splice(index, 1);
            saveAddressesToStorage();
            updateAddressesList();

            // Scroll to form
            document.getElementById('manualSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('manualFirst').focus();
        }

        function deleteManualAddress(index) {
            if (manualAddresses.length === 1) {
                if (confirm('This will remove the last address. Continue?')) {
                    manualAddresses = [];
                    saveAddressesToStorage();
                    updateAddressesList();
                }
                return;
            }
            manualAddresses.splice(index, 1);
            saveAddressesToStorage();
            updateAddressesList();
        }

        function generateFromManual() {
            if (manualAddresses.length === 0) return;

            const template = TEMPLATES[currentTemplate];
            const labelsPerPage = template.cols * template.rows;
            const fullSheetCheckbox = document.getElementById('manualFullSheetCheckbox');

            let addressesToPrint = manualAddresses;

            // If full sheet is checked and there's exactly one address, replicate it
            if (fullSheetCheckbox && fullSheetCheckbox.checked && manualAddresses.length === 1) {
                addressesToPrint = Array(labelsPerPage).fill(manualAddresses[0]);
            }

            showStatus(`Generating PDF labels for ${addressesToPrint.length} labels...`, 'processing');

            try {
                const pdf = generateLabelsPDF(addressesToPrint);
                pdf.save(`${currentTemplate}-labels.pdf`);

                const totalPages = Math.ceil(addressesToPrint.length / labelsPerPage);
                showStatus(`‚úì Success! Generated ${addressesToPrint.length} labels (${totalPages} page${totalPages > 1 ? 's' : ''}). PDF download started.`, 'success');
            } catch (error) {
                console.error(error);
                showStatus('Error generating labels: ' + error.message, 'error');
            }
        }

        // Sample address data - expanded format
        const SAMPLE_ADDRESSES = [
            ['Title', 'First Name', 'Last Name', 'Suffix', 'Address 1', 'Address 2', 'City', 'State', 'Postal Code', 'Country'],
            ['', 'John', 'Smith', '', '123 Main St', '', 'New York', 'NY', '10001', 'USA'],
            ['Dr.', 'Jane', 'Doe', 'PhD', '456 Oak Ave', 'Suite 200', 'Boston', 'MA', '02101', 'USA'],
            ['', 'Robert', 'Johnson', '', '789 Pine Rd', '', 'Chicago', 'IL', '60601', 'USA'],
            ['', 'Maria', 'Garcia', '', '321 Maple Dr', 'Apt 4B', 'Los Angeles', 'CA', '90001', 'USA'],
            ['Hon.', 'David', 'Lee', 'Jr.', '654 Cedar Ln', '', 'Houston', 'TX', '77001', 'USA'],
            ['', 'Sarah', 'Wilson', '', '987 Birch St', '', 'Phoenix', 'AZ', '85001', 'USA'],
            ['', 'Michael', 'Brown', '', '147 Elm Ave', 'Unit 12', 'Philadelphia', 'PA', '19101', 'USA'],
            ['', 'Emily', 'Davis', '', '258 Walnut Blvd', '', 'San Antonio', 'TX', '78201', 'USA'],
            ['', 'Christopher', 'Martinez', '', '369 Ash Ct', '', 'San Diego', 'CA', '92101', 'USA'],
            ['', 'Jessica', 'Anderson', '', '741 Oak Circle', '', 'Dallas', 'TX', '75201', 'USA']
        ];

        // Helper function to download addresses as CSV
        function downloadAddressesCSV(addresses, filename) {
            const header = ['Title', 'First Name', 'Last Name', 'Suffix', 'Address 1', 'Address 2', 'City', 'State', 'Postal Code', 'Country'];

            const escapeCsvField = (field) => {
                const str = field || '';
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            const rows = addresses.map(addr => {
                // Handle both old and new format
                if (addr.firstName !== undefined) {
                    // New format
                    return [
                        escapeCsvField(addr.title),
                        escapeCsvField(addr.firstName),
                        escapeCsvField(addr.lastName),
                        escapeCsvField(addr.suffix),
                        escapeCsvField(addr.address1),
                        escapeCsvField(addr.address2),
                        escapeCsvField(addr.city),
                        escapeCsvField(addr.state),
                        escapeCsvField(addr.postalCode),
                        escapeCsvField(addr.country)
                    ].join(',');
                } else {
                    // Old format - convert to new header format as best we can
                    const nameParts = (addr.fullname || '').split(' ');
                    return [
                        '', // title
                        escapeCsvField(nameParts[0] || ''),
                        escapeCsvField(nameParts.slice(1).join(' ') || ''),
                        '', // suffix
                        escapeCsvField(addr.address),
                        '', // address2
                        escapeCsvField(addr.cityStateZip),
                        '', // state
                        '', // postal code
                        ''  // country
                    ].join(',');
                }
            });

            const csvContent = [header.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export manual addresses to CSV
        function exportManualAddressesCSV() {
            if (manualAddresses.length === 0) return;
            downloadAddressesCSV(manualAddresses, 'my-addresses.csv');
            showStatus(`Exported ${manualAddresses.length} address${manualAddresses.length !== 1 ? 'es' : ''} to CSV.`, 'success');
        }

        // Download example CSV file
        function downloadExampleCSV() {
            const csvContent = SAMPLE_ADDRESSES.map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', 'example-addresses.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Download example Excel file
        function downloadExampleExcel() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // Create worksheet from array data
            const ws = XLSX.utils.aoa_to_sheet(SAMPLE_ADDRESSES);

            // Set column widths for new 10-column format
            ws['!cols'] = [
                { wch: 8 },   // Title
                { wch: 15 },  // First Name
                { wch: 15 },  // Last Name
                { wch: 8 },   // Suffix
                { wch: 25 },  // Address 1
                { wch: 15 },  // Address 2
                { wch: 15 },  // City
                { wch: 8 },   // State
                { wch: 12 },  // Postal Code
                { wch: 10 }   // Country
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Addresses');

            // Generate Excel file and trigger download
            XLSX.writeFile(wb, 'example-addresses.xlsx');
        }
    </script>
</body>
</html>
